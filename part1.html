<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 1</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
        default: 'arcade',
            arcade: {
                gravity: { y: 0 },
                debug: true
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update,
            extend: { // dig this
                        bullets: null,
                        time: 0,
                        testText :"",
                    }
        }
    };

    var game = new Phaser.Game(config);
    var lastFired = 0;
    var bearStat = 'right';
    const initialBearSpeed = 100;
    var bearSpeed = initialBearSpeed;
    const bulletSpeed = 1.2;
    const gunSpeed = 800;

    // size of the space drone can stay
    const xMin = 200, xMax = 600, yMin = 100, yMax = 500;

    var hitCount = 0;

    var Bullet = new Phaser.Class({

        Extends: Phaser.GameObjects.Image,

        initialize:

        function Bullet (scene)
        {
            Phaser.GameObjects.Image.call(this, scene, 0, 0, 'bullet');

            this.speed = bulletSpeed;
            this.direction = 0;
            this.xSpeed = 0;
            this.ySpeed = 0;
            this.setSize(12, 12, true);
            this.solidX = 0;
        },

        fire: function (x, y)
        {
            this.setPosition(x, y - 50);
            // tilting happens after collision
            // force the bullet to stay on the vertical trace
            this.solidX = x;

            this.setActive(true);
            this.setVisible(true);
        },

        update: function (time, delta)
        {
            this.x = this.solidX;
            this.y -= this.speed * delta;
            testText.setText('pos : ' + this.x + " " + this.y );

            if (this.y < -50)
                this.destroy();
        }
    });

    function preload ()
    {
        this.load.image('sky', 'assets/sky.png');
        this.load.image('iceberg', 'assets/iceberg.png');
        this.load.image('present', 'assets/present.png');
        this.load.image('star', 'assets/star.png');
        this.load.image('bomb', 'assets/bomb.png');
        this.load.image('bullet', 'assets/bullet.png');
        this.load.image('gun', 'assets/gun.png');
        this.load.image('bear', 'assets/santa_drone.png');
    }

    var Item = new Phaser.Class({
        Extends: Phaser.Physics.Arcade.Image,

        initialize:
        function Item(scene, xpos, ypos)
        {
            Phaser.Physics.Arcade.Image.call(this, scene, xpos, ypos, 'present');
        },
    });

    function create ()
    {
        this.add.image(400, 300, 'sky');
        // this.add.image(400, 250, 'iceberg').setScale(3);
        // 300~500, 150~350
        
        gun = this.physics.add.sprite(100, 560, 'gun').setScale(0.3);
        gun.setCollideWorldBounds(true);

        // this.physics.world.setBounds(0, 0, 800, 550);
        bear = this.physics.add.sprite(320, 160, 'bear');
        bear.setCollideWorldBounds(true);

        //used to test stuff
        testText = this.add.text(16, 16, 'stat: right', { fontSize: '32px', fill: '#000' });


        bullets = this.physics.add.group({
            classType: Bullet,
            maxSize: 3,
            runChildUpdate: true
        });;

        bear.setVelocityX(bearSpeed);
        // bear.anims.play('right', true);
        bear.onOverlap = true;

        cursors = this.input.keyboard.createCursorKeys();

        gifts = this.physics.add.group({
            classType: Item,
            runChildUpdate: false
        })

        for (var i = 8; i >= 0; i--) {
            var xpos = Math.floor(Math.random() * (xMax - xMin)) + xMin;
            var ypos = Math.floor(Math.random() * (yMax - yMin)) + yMin;
            // console.log(xpos + ", " + ypos);
            var gift = new Item(this, xpos, ypos);
            gifts.add(gift, true);
        }
        this.physics.add.overlap(bear, gifts, giftOverlap);
    }

    function giftOverlap(bearObject, giftObject)
    {
        giftObject.destroy();
    }

    function hitCallback(bearHit, bulletHit)
    {
        // alert("I am an alert box!!");
        // Reduce health of enemy
        if (bulletHit.active === true && bearHit.active === true)
        {
            // Destroy bullet
            bulletHit.destroy();
            
            // Bear turn counterclockwise
            bearHit.setVelocity(0);
            if (bearStat == "right")
            {
                // turn up
                bearStat = "up";
                bearHit.setVelocityY(-bearSpeed)
                // bear.anims.play('turn', true);
                bear.setAngle(0);
            }
            else if (bearStat == "left")
            {
                bearStat = "down";
                bearHit.setVelocityY(bearSpeed)
                // bear.anims.play('turn', true);
                bear.setAngle(180);

            }
            else if (bearStat == "up")
            {
                bearStat = "left";
                bearHit.setVelocityX(-bearSpeed)
                // bear.anims.play('left', true);
                bear.setAngle(-90);
            }
            else if (bearStat == "down")
            {
                bearStat = "right";
                bearHit.setVelocityX(bearSpeed)
                // bear.anims.play('right', true);
                bear.setAngle(90);
            }

            // testText.setText('Stat : ' + bearStat + " " + bearHit.body.velocity.x +" "+bearHit.body.velocity.y);
            // accelerate the bear!
            hitCount ++;
            bearSpeed = ( Math.tanh(hitCount * 0.3 - 4 ) + 2) * 1.5 * initialBearSpeed;
            
        }
    }

    function update (time, delta)
    {
        gun.setVelocityX(0);
        if (cursors.left.isDown)
        {
            gun.setVelocityX(-gunSpeed);
        }
        else if (cursors.right.isDown)
        {
            gun.setVelocityX(gunSpeed);
        }
        if (cursors.space.isDown && time > lastFired)
        {
            var bullet = bullets.get();
            if (bullet)
            {
                this.physics.add.overlap(bear, bullet, hitCallback);
                bullet.fire(gun.x, gun.y);
                lastFired = time + 500;
            }
        }

        if (bear.x < xMin || bear.x > xMax || bear.y < yMin || bear.y > yMax)
        {
            bear.setVelocity(0);
            // fake animation
            bear.setAngle(90);
            bear.setAngle(180);
            bear.setAngle(-90);
            bear.setAngle(0);
        }
            
    }

</script>

</body>
</html>