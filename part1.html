<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 1</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
        default: 'arcade',
            arcade: {
                gravity: { y: 0 },
                debug: true
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update,
            extend: { // dig this
                        bullets: null,
                        time: 0,
                        testText :"",
                    }
        }
    };

    var game = new Phaser.Game(config);
    var fishPos = new Array(64);//8*8 
    var lastFired = 0;
    var bearStat = 'right';
    const bearSpeed = 50;

    var Bullet = new Phaser.Class({

        Extends: Phaser.GameObjects.Image,

        initialize:

        function Bullet (scene)
        {
            Phaser.GameObjects.Image.call(this, scene, 0, 0, 'bullet');

            this.speed = 0.5;
            this.direction = 0;
            this.xSpeed = 0;
            this.ySpeed = 0;
            this.setSize(12, 12, true);
            this.solidX = 0;
        },

        fire: function (x, y)
        {
            this.setPosition(x, y - 50);
            // tilting happens after collision
            // force the bullet to stay on the vertical trace
            this.solidX = x;

            this.setActive(true);
            this.setVisible(true);
        },

        update: function (time, delta)
        {
            this.x = this.solidX;
            this.y -= this.speed * delta;
            testText.setText('pos : ' + this.x + " " + this.y );

            if (this.y < -50)
            {
                this.setActive(false);
                this.setVisible(false);
            }
        }
    });

    function preload ()
    {
        this.load.image('sky', 'assets/sky.png');
        this.load.image('iceberg', 'assets/iceberg.png');
        this.load.image('star', 'assets/star.png');
        this.load.image('bomb', 'assets/bomb.png');
        this.load.image('bullet', 'assets/bullet.png');
        this.load.image('gun', 'assets/gun.png');
        this.load.spritesheet('bear', 
            'assets/dude.png',
            { frameWidth: 32, frameHeight: 48 }
        );
    }

    function create ()
    {
        this.add.image(400, 300, 'sky');
        // this.add.image(400, 250, 'iceberg').setScale(3);
        // 300~500, 150~350
        
        gun = this.physics.add.sprite(100, 560, 'gun').setScale(0.3);
        gun.setCollideWorldBounds(true);

        // this.physics.world.setBounds(0, 0, 800, 550);
        bear = this.physics.add.sprite(320, 160, 'bear');
        bear.setCollideWorldBounds(true);

        //used to test stuff
        testText = this.add.text(16, 16, 'stat: right', { fontSize: '32px', fill: '#000' });


        bullets = this.physics.add.group({
            classType: Bullet,
            maxSize: 3,
            runChildUpdate: true
        });

        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('bear', { start: 0, end: 3 }),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key: 'turn',
            frames: [ { key: 'bear', frame: 4 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('bear', { start: 5, end: 8 }),
            frameRate: 10,
            repeat: -1
        });

        bear.setVelocityX(bearSpeed);
        bear.anims.play('right', true);

        cursors = this.input.keyboard.createCursorKeys();

        // forget about the grammar
        // fishs = this.physics.add.group({
        //     key: 'star',
        //     repeat: 11,
        //     // TODO. random positions
        //     setXY: { x: 12, y: 12, stepX: 70 }
        // });

        // fishs.children.iterate(function (child) {

        //     child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

        // }) ;
    }

    function hitCallback(bearHit, bulletHit)
    {
        // alert("I am an alert box!!");
        // Reduce health of enemy
        if (bulletHit.active === true && bearHit.active === true)
        {
            // Destroy bullet
            bulletHit.setActive(false);
            bulletHit.setVisible(false);
            
            // Bear turn counterclockwise
            bearHit.setVelocityX(0);
            bearHit.setVelocityY(0);
            if (bearStat == "right")
            {
                // turn up
                bearStat = "up";
                bearHit.setVelocityY(-bearSpeed)
                bear.anims.play('turn', true);
            }
            else if (bearStat == "left")
            {
                bearStat = "down";
                bearHit.setVelocityY(bearSpeed)
                bear.anims.play('turn', true);
            }
            else if (bearStat == "up")
            {
                bearStat = "left";
                bearHit.setVelocityX(-bearSpeed)
                bear.anims.play('left', true);
            }
            else if (bearStat == "down")
            {
                bearStat = "right";
                bearHit.setVelocityX(bearSpeed)
                bear.anims.play('right', true);
            }

            // testText.setText('Stat : ' + bearStat + " " + bearHit.body.velocity.x +" "+bearHit.body.velocity.y);
        }
    }

    function update (time, delta)
    {
        gun.setVelocityX(0);
        if (cursors.left.isDown)
        {
            gun.setVelocityX(-400);
        }
        else if (cursors.right.isDown)
        {
            gun.setVelocityX(400);
        }
        if (cursors.space.isDown && time > lastFired)
        {
            // move&shooting is not allowed
            var bullet = bullets.get();

            if (bullet)
            {
                // alert("thisiiiii");
                this.physics.add.collider(bear, bullet, hitCallback);
                // bullet.setBounce(0.2);
                bullet.fire(gun.x, gun.y);
                lastFired = time + 500;
            }
        }
    }

</script>

</body>
</html>